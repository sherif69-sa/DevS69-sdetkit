name: Security Maintenance Bot

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: "30 3 * * *"

permissions:
  contents: read
  issues: write
  security-events: write

jobs:
  secret-scan:
    name: Secret scan (gitleaks)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4
        with:
          fetch-depth: 0

      - name: Run gitleaks
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7  # v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_ENABLE_COMMENTS: "false"
          GITLEAKS_ENABLE_UPLOAD_ARTIFACT: "true"

      - name: Check SARIF presence
        if: always()
        id: sarif
        run: |
          if [ -f results.sarif ]; then
            echo 'present=true' >> "$GITHUB_OUTPUT"
          else
            echo 'present=false' >> "$GITHUB_OUTPUT"
          fi

      - name: Send SARIF
        if: steps.sarif.outputs.present == 'true'
        uses: github/codeql-action/upload-sarif@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2  # v4
        with:
          sarif_file: results.sarif

  weekly-maintenance-issue:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Create or update weekly maintenance issue
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b  # v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const title = `ðŸ” Weekly security + maintenance checklist`;
            const maintenanceLabel = 'maintenance';
            const enhancementLabel = 'enhancement';
            const priorityLabel = 'priority:medium';

            const body = [
              'This issue is auto-generated to keep the repository secure and continuously updated.',
              '',
              '## Security auto-update checklist',
              '- [ ] Review Dependabot PRs and approve any major upgrades.',
              '- [ ] Confirm all security workflows are green in Actions (security.yml, osv-scanner.yml, security-maintenance-bot.yml).',
              '- [ ] Review GitHub code scanning alerts and close/resolution as needed.',
              '- [ ] Review open vulnerabilities in Dependency graph.',
              '',
              '## Suggested enhancement pipeline',
              '- [ ] Open at least 1 enhancement issue from customer/user feedback.',
              '- [ ] Tag enhancements with `enhancement` and priority labels.',
              '- [ ] Link roadmap updates in `docs/roadmap.md`.',
              '',
              '## Quick links',
              `- Code scanning: https://github.com/${owner}/${repo}/security/code-scanning`,
              `- Dependabot: https://github.com/${owner}/${repo}/security/dependabot`,
              `- Actions: https://github.com/${owner}/${repo}/actions`,
            ].join('\n');

            const labels = [
              { name: maintenanceLabel, color: '0E8A16', description: 'Automated maintenance tracking' },
              { name: enhancementLabel, color: 'a2eeef', description: 'Feature work and product improvements' },
              { name: 'priority:high', color: 'd93f0b', description: 'High-priority work item' },
              { name: priorityLabel, color: 'fbca04', description: 'Medium-priority work item' },
              { name: 'priority:low', color: '0e8a16', description: 'Low-priority work item' },
            ];

            for (const lbl of labels) {
              try {
                await github.rest.issues.getLabel({ owner, repo, name: lbl.name });
              } catch {
                await github.rest.issues.createLabel({ owner, repo, ...lbl });
              }
            }

            const maintenanceIssues = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              labels: maintenanceLabel,
              per_page: 100,
            });

            const existingMaintenance = maintenanceIssues.data.find(i => i.title === title);
            if (existingMaintenance) {
              await github.rest.issues.update({ owner, repo, issue_number: existingMaintenance.number, body });
            } else {
              await github.rest.issues.create({ owner, repo, title, body, labels: [maintenanceLabel] });
            }

            const enhancementTitle = 'ðŸ§© Monthly enhancement intake from user feedback';
            const enhancementBody = [
              'This issue is auto-generated to ensure at least one enhancement candidate is always tracked.',
              '',
              '## Enhancement backlog starter',
              '- [ ] Capture one concrete user pain point from support, issues, or docs feedback.',
              '- [ ] Define acceptance criteria and expected impact.',
              '- [ ] Add/update roadmap context in `docs/roadmap.md`.',
              '',
              '## Suggested metadata',
              `- Labels: \`${enhancementLabel}\`, \`${priorityLabel}\``,
              '- Link the final implementation PR back to this issue.',
            ].join('\n');

            const enhancementIssues = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              labels: enhancementLabel,
              per_page: 100,
            });

            const existingEnhancement = enhancementIssues.data.find(i => i.title === enhancementTitle);
            if (!existingEnhancement) {
              await github.rest.issues.create({
                owner,
                repo,
                title: enhancementTitle,
                body: enhancementBody,
                labels: [enhancementLabel, priorityLabel],
              });
            }
